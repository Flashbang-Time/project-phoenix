<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Phoenix: QEMU Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .log-box {
            background-color: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 0.5rem;
            padding: 1rem;
            height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
            color: #cbd5e1;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-box span.error { color: #f87171; }
        .log-box span.success { color: #4ade80; }
        .log-box span.info { color: #60a5fa; }
        .log-box span.command { color: #f3f4f6; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 h-screen fixed left-0 top-0 flex flex-col">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold text-white">Project Phoenix</h1>
            <p class="text-xs text-gray-400">QEMU Control Panel</p>
        </div>
        <nav class="flex-1 p-4">
            <ul class="space-y-2">
                <li><a href="http://127.0.0.1:5000" class="block px-3 py-2 rounded hover:bg-gray-700">VM Settings</a></li>
                <li><a href="http://127.0.0.1:5000/vncgui" class="block px-3 py-2 rounded hover:bg-gray-700">VNC</a></li>
                <li><a href="http://127.0.0.1:5000/terminal" class="block px-3 py-2 rounded hover:bg-gray-700">Terminal</a></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-700 text-xs text-gray-400">
            Â© 2025 Project Phoenix
        </div>
    </aside>

    <!-- Main Content -->
    <div class="ml-64 flex-1 flex flex-col min-h-screen">

        <!-- Top Navbar -->
        <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center">
            <h2 class="text-lg font-semibold">VM Settings</h2>
            <div id="statusMessage" class="text-sm text-gray-300">
                VM Status: <span id="vmStatusText" class="font-bold">Checking...</span>
            </div>
        </header>

        <!-- Content Area -->
        <main class="p-6 space-y-6">

            <!-- Core Settings Card -->
            <div class="bg-gray-800 rounded-lg shadow p-6">
             
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="ramInput" class="block text-sm text-gray-300 mb-2">RAM (MB)</label>
                        <input type="number" id="ramInput" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2" value="8192" min="512" max="32768">
                    </div>
                    <div>
                        <label for="coresInput" class="block text-sm text-gray-300 mb-2">CPU Cores</label>
                        <input type="number" id="coresInput" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2" value="6" min="1" max="12">
                    </div>
                    <div>
                        <label for="cpuModelSelect" class="block text-sm text-gray-300 mb-2">CPU Model</label>
                        <select id="cpuModelSelect" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2"></select>
                    </div>
                </div>
            </div>

            <!-- Storage Settings -->
            <div class="bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Storage</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2 text-gray-300">Primary Disk Image Path (.qcow2)</label>
                        <input type="text" id="primaryDiskPathInput" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2" placeholder="Windows_100G.qcow2">
                    </div>
                    <div>
                        <label class="block text-sm mb-2 text-gray-300">CD-ROM / ISO Path</label>
                        <input type="text" id="cdromPathInput" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2" placeholder="win10.iso">
                    </div>
                    <div>
                        <label class="block text-sm mb-2 text-gray-300">Secondary Data Disk (.qcow2)</label>
                        <input type="text" id="dataDiskPathInput" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2" placeholder="data.qcow2">
                    </div>
                </div>
            </div>

            <!-- Network & Display -->
            <div class="bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Network & Display</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">Network Device Model</label>
                        <select id="netDeviceSelect" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">VGA Display Model</label>
                        <select id="vgaModelSelect" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">Boot Order</label>
                        <select id="bootOrderSelect" class="w-full rounded bg-gray-700 border border-gray-600 text-white p-2"></select>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-4">
                <button id="startButton" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded text-white font-bold">Start VM</button>
                <button id="stopButton" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded text-white font-bold" disabled>Stop VM</button>
            </div>



       

        </main>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        // --- Core Constants and DOM Elements ---
        const SERVER_URL = 'http://127.0.0.1:5000'; // Flask server URL

        const ramInput = document.getElementById('ramInput');
        const coresInput = document.getElementById('coresInput');
        const cpuModelSelect = document.getElementById('cpuModelSelect');
        const primaryDiskPathInput = document.getElementById('primaryDiskPathInput');
        const cdromPathInput = document.getElementById('cdromPathInput');
        const dataDiskPathInput = document.getElementById('dataDiskPathInput');
        const netDeviceSelect = document.getElementById('netDeviceSelect');
        const vgaModelSelect = document.getElementById('vgaModelSelect');
        const bootOrderSelect = document.getElementById('bootOrderSelect');

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        let vmStatusText = document.getElementById('vmStatusText'); // Needs 'let' as its reference is updated

        const statusMessageDiv = document.getElementById('statusMessage');
        const terminalOutput = document.getElementById('terminalOutput');
        const terminalInput = document.getElementById('terminalInput');
        const runCommandBtn = document.getElementById('runCommandBtn');

        // Lists for dropdowns
        const CPU_MODELS = ["max", "qemu64", "host", "Haswell-v4", "Skylake-Client-v4",
                            "GraniteRapids-v1", "Cascadelake-Server-v5", "EPYC-v4",
                            "Icelake-Server-v6", "SapphireRapids-v2"];
        const NET_DEVICES = ["virtio-net-pci", "e1000", "rtl8139"];
        const VGA_MODELS = ["virtio", "std", "qxl", "vmware", "cirrus"];
        const BOOT_ORDERS = ["c", "d", "n", "cd", "dc", "ncd", "dcn"];

        // --- Initialization: Populate Dropdowns ---
        function populateDropdown(selectElement, optionsArray) {
            selectElement.innerHTML = ''; // Clear existing options
            optionsArray.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

        populateDropdown(cpuModelSelect, CPU_MODELS);
        populateDropdown(netDeviceSelect, NET_DEVICES);
        populateDropdown(vgaModelSelect, VGA_MODELS);
        populateDropdown(bootOrderSelect, BOOT_ORDERS);

        // --- Fetch Default VM Config ---
        async function fetchDefaults() {
            try {
                const response = await fetch(`${SERVER_URL}/get_defaults`);
                const data = await response.json();
                ramInput.value = data.default_ram_mb;
                coresInput.value = data.default_cores;
                cpuModelSelect.value = data.default_cpu_model;
                primaryDiskPathInput.value = data.default_primary_disk_path;
                cdromPathInput.value = data.default_cdrom_path;
                dataDiskPathInput.value = data.default_data_disk_path;
                netDeviceSelect.value = data.default_net_device;
                vgaModelSelect.value = data.default_vga_model;
                bootOrderSelect.value = data.default_boot_order;
            } catch (error) {
                console.error('Error fetching defaults:', error);
                alertUser('Could not load default settings from server. Using fallback defaults.', 'error');
            }
        }
        fetchDefaults(); // Load defaults on startup

        // --- VM Status & Control ---
        async function updateVmStatus() {
            try {
                const response = await fetch(`${SERVER_URL}/vm_status`);
                const data = await response.json();
                if (data.running) {
                    vmStatusText.textContent = 'Running';
                    vmStatusText.classList.remove('text-red-400', 'text-yellow-400');
                    vmStatusText.classList.add('text-green-400');
                    startButton.disabled = true;
                    stopButton.disabled = false;
                } else {
                    vmStatusText.textContent = 'Stopped';
                    vmStatusText.classList.remove('text-green-400', 'text-yellow-400');
                    vmStatusText.classList.add('text-red-400');
                    startButton.disabled = false;
                    stopButton.disabled = true;
                }
            } catch (error) {
                console.error('Error fetching VM status (server potentially down):', error);
                vmStatusText.textContent = 'Error (Server Down?)';
                vmStatusText.classList.remove('text-green-400', 'text-red-400');
                vmStatusText.classList.add('text-yellow-400');
                startButton.disabled = true;
                stopButton.disabled = true;
            }
        }

        // --- VM Control Event Listeners ---
        startButton.addEventListener('click', async () => {
            const config = {
                ram_mb: parseInt(ramInput.value),
                cores: parseInt(coresInput.value),
                cpu_model: cpuModelSelect.value,
                primary_disk_path: primaryDiskPathInput.value.trim(),
                cdrom_path: cdromPathInput.value.trim(),
                data_disk_path: dataDiskPathInput.value.trim(),
                net_device: netDeviceSelect.value,
                vga_model: vgaModelSelect.value,
                boot_order: bootOrderSelect.value
            };

            // Basic client-side validation (server will also validate)
            if (isNaN(config.ram_mb) || config.ram_mb < 512 || config.ram_mb > 32768) { alertUser('Please enter valid RAM (512-32768 MB).', 'error'); return; }
            if (isNaN(config.cores) || config.cores < 1 || config.cores > 12) { alertUser('Please enter valid CPU Cores (1-12).', 'error'); return; }
            if (!config.primary_disk_path) { alertUser('Primary Disk Path is required.', 'error'); return; }
            // Add more client-side validation if desired

            alertUser('Starting VM...', 'info');
            startButton.disabled = true;
            stopButton.disabled = true;

            try {
                const response = await fetch(`${SERVER_URL}/start_vm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                alertUser(data.message, data.status);
            } catch (error) {
                console.error("Start VM fetch error:", error);
                alertUser('Failed to send start command to server. Server unreachable?', 'error');
            } finally {
                setTimeout(updateVmStatus, 2000); // Poll status after delay
            }
        });

        stopButton.addEventListener('click', async () => {
            alertUser('Stopping VM...', 'warning');
            startButton.disabled = true;
            stopButton.disabled = true;

            try {
                const response = await fetch(`${SERVER_URL}/stop_vm`, { method: 'POST' });
                const data = await response.json();
                alertUser(data.message, data.status);
            } catch (error) {
                console.error("Stop VM fetch error:", error);
                alertUser('Failed to send stop command to server. Server unreachable?', 'error');
            } finally {
                setTimeout(updateVmStatus, 1000); // Poll status after delay
            }
        });

        // --- Alert/Status Message Display ---
        function alertUser(message, type) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `mt-6 p-4 rounded-lg text-center font-semibold transition-colors duration-300`;
            switch (type) {
                case 'success': statusMessageDiv.classList.add('bg-green-800', 'text-green-100'); break;
                case 'error': statusMessageDiv.classList.add('bg-red-800', 'text-red-100'); break;
                case 'warning': statusMessageDiv.classList.add('bg-yellow-800', 'text-yellow-100'); break;
                case 'info':
                default: statusMessageDiv.classList.add('bg-gray-800', 'text-gray-300'); break;
            }
            // Reset status message after a few seconds
            setTimeout(() => {
                statusMessageDiv.className = 'mt-6 p-4 rounded-lg text-center font-semibold bg-gray-800 text-gray-300 transition-colors duration-300';
                statusMessageDiv.innerHTML = 'VM Status: <span id="vmStatusText" class="font-bold">Checking...</span>';
                vmStatusText = document.getElementById('vmStatusText'); // Re-get reference
                updateVmStatus(); // Refresh actual status
            }, 5000);
        }

    
        // --- Initial Load & Polling Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Content Loaded. Initializing Phoenix UI.");
            
            // Initial status and logs fetch after a short delay
            setTimeout(async () => {
                await updateVmStatus(); 
                await getTerminalOutput(); 
            }, 750); 

            // Set up regular polling
            setInterval(updateVmStatus, 5000); // Poll VM status every 5 seconds
            setInterval(getTerminalOutput, 1500); // Poll terminal output every 1.5 seconds
        });
    </script>
</body>
</html>
